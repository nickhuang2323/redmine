# Generated by Copilot
"""
Git History æœå‹™å¯¦ç¾
è™•ç† git commit history åˆ†æå’Œ issue ç·¨è™Ÿæå–
"""
import subprocess
import re
from typing import List, Set, Optional
from pathlib import Path
from dataclasses import dataclass


@dataclass
class GitCommit:
    """Git commit è³‡è¨Š"""
    hash: str
    message: str
    author: str
    date: str
    issue_numbers: List[str]


class GitHistoryExtractor:
    """Git history æå–å™¨"""
    
    def __init__(self, repo_path: str = "."):
        """
        åˆå§‹åŒ– Git history æå–å™¨
        
        Args:
            repo_path: Git å„²å­˜åº«è·¯å¾‘ï¼Œé è¨­ç‚ºç•¶å‰ç›®éŒ„
        """
        self._repo_path = Path(repo_path).resolve()
        
    def extract_issue_numbers_from_file(self, file_path: str, pattern: str = r"refs\s+#(\d+)") -> str:
        """
        å¾æŒ‡å®šæª”æ¡ˆçš„ git history ä¸­æå–ç¬¦åˆ refs #00000 æ ¼å¼çš„ issue ç·¨è™Ÿ
        
        Args:
            file_path: æª”æ¡ˆè·¯å¾‘
            pattern: æ­£è¦è¡¨é”å¼æ¨¡å¼ï¼Œé è¨­ç‚º "refs #æ•¸å­—"
            
        Returns:
            é€—è™Ÿåˆ†éš”çš„ issue ç·¨è™Ÿå­—ä¸²ï¼Œä¾‹å¦‚ "12345,12346,12347"
        """
        try:
            # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
            full_path = self._repo_path / file_path
            if not full_path.exists():
                print(f"âŒ æª”æ¡ˆä¸å­˜åœ¨: {full_path}")
                return ""
                
            # å–å¾—æª”æ¡ˆçš„ git log
            commits = self._get_file_commits(file_path)
            
            # æå– issue ç·¨è™Ÿ
            issue_numbers = self._extract_issue_numbers_from_commits(commits, pattern)
            
            # å›å‚³é€—è™Ÿåˆ†éš”çš„å­—ä¸²
            return ",".join(sorted(issue_numbers))
            
        except Exception as e:
            print(f"âŒ æå– git history å¤±æ•—: {e}")
            return ""
    
    def get_file_commit_history(self, file_path: str) -> List[GitCommit]:
        """
        å–å¾—æŒ‡å®šæª”æ¡ˆçš„å®Œæ•´ commit history
        
        Args:
            file_path: æª”æ¡ˆè·¯å¾‘
            
        Returns:
            GitCommit ç‰©ä»¶åˆ—è¡¨
        """
        try:
            commits = self._get_file_commits(file_path)
            git_commits = []
            
            for commit in commits:
                # æå– issue ç·¨è™Ÿ
                issue_numbers = self._extract_issue_numbers_from_commits([commit])
                
                git_commit = GitCommit(
                    hash=commit.get('hash', ''),
                    message=commit.get('message', ''),
                    author=commit.get('author', ''),
                    date=commit.get('date', ''),
                    issue_numbers=list(issue_numbers)
                )
                git_commits.append(git_commit)
                
            return git_commits
            
        except Exception as e:
            print(f"âŒ å–å¾— commit history å¤±æ•—: {e}")
            return []
    
    def _get_file_commits(self, file_path: str) -> List[dict]:
        """
        ä½¿ç”¨ git log å–å¾—æª”æ¡ˆçš„ commit è¨˜éŒ„
        
        Args:
            file_path: æª”æ¡ˆè·¯å¾‘
            
        Returns:
            commit è¨˜éŒ„åˆ—è¡¨
        """
        try:
            # å»ºæ§‹ git log å‘½ä»¤
            cmd = [
                'git', 'log', 
                '--follow',  # è¿½è¹¤æª”æ¡ˆé‡æ–°å‘½å
                '--format=%H|%an|%ad|%s',  # hash|author|date|subject
                '--date=iso',
                '--',
                file_path
            ]
            
            print(f"ğŸ” åŸ·è¡Œ Git å‘½ä»¤: {' '.join(cmd)}")
            print(f"ğŸ“ å·¥ä½œç›®éŒ„: {self._repo_path}")
            print(f"ğŸ“„ æª”æ¡ˆè·¯å¾‘: {file_path}")
            
            # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼å·¥ä½œç›®éŒ„ä¸­
            full_file_path = self._repo_path / file_path
            print(f"ğŸ” å®Œæ•´æª”æ¡ˆè·¯å¾‘: {full_file_path}")
            print(f"ğŸ“ æª”æ¡ˆæ˜¯å¦å­˜åœ¨: {full_file_path.exists()}")
            
            # åŸ·è¡Œå‘½ä»¤
            result = subprocess.run(
                cmd,
                cwd=self._repo_path,
                capture_output=True,
                text=True,
                encoding='utf-8'
            )
            
            if result.returncode != 0:
                print("âŒ Git å‘½ä»¤åŸ·è¡Œå¤±æ•—:")
                print(f"   è¿”å›ç¢¼: {result.returncode}")
                print(f"   éŒ¯èª¤è¼¸å‡º: {result.stderr}")
                print(f"   æ¨™æº–è¼¸å‡º: {result.stdout}")
                return []
            
            # è§£æè¼¸å‡º
            commits = []
            lines = result.stdout.strip().split('\n')
            
            for line in lines:
                if line.strip():
                    parts = line.split('|', 3)
                    if len(parts) >= 4:
                        commit = {
                            'hash': parts[0],
                            'author': parts[1],
                            'date': parts[2],
                            'message': parts[3]
                        }
                        commits.append(commit)
            
            return commits
            
        except Exception as e:
            print(f"âŒ åŸ·è¡Œ git log å¤±æ•—: {e}")
            return []
    
    def _extract_issue_numbers_from_commits(self, commits: List[dict], pattern: str = r"refs\s+#(\d+)") -> Set[str]:
        """
        å¾ commit è¨Šæ¯ä¸­æå– issue ç·¨è™Ÿ
        
        Args:
            commits: commit è¨˜éŒ„åˆ—è¡¨
            pattern: æ­£è¦è¡¨é”å¼æ¨¡å¼
            
        Returns:
            issue ç·¨è™Ÿé›†åˆ
        """
        issue_numbers = set()
        regex = re.compile(pattern, re.IGNORECASE)
        
        for commit in commits:
            message = commit.get('message', '')
            matches = regex.findall(message)
            issue_numbers.update(matches)
        
        return issue_numbers


class GitService:
    """Git æœå‹™ä¸»é¡åˆ¥"""
    
    def __init__(self, repo_path: str = "."):
        """
        åˆå§‹åŒ– Git æœå‹™
        
        Args:
            repo_path: Git å„²å­˜åº«è·¯å¾‘
        """
        self._extractor = GitHistoryExtractor(repo_path)
    
    def get_issue_numbers_from_file(self, file_path: str) -> str:
        """
        å¾æª”æ¡ˆçš„ git history å–å¾— issue ç·¨è™Ÿå­—ä¸²
        
        Args:
            file_path: æª”æ¡ˆè·¯å¾‘
            
        Returns:
            é€—è™Ÿåˆ†éš”çš„ issue ç·¨è™Ÿå­—ä¸²
        """
        return self._extractor.extract_issue_numbers_from_file(file_path)
    
    def get_file_history(self, file_path: str) -> List[GitCommit]:
        """
        å–å¾—æª”æ¡ˆçš„å®Œæ•´ git history
        
        Args:
            file_path: æª”æ¡ˆè·¯å¾‘
            
        Returns:
            GitCommit ç‰©ä»¶åˆ—è¡¨
        """
        return self._extractor.get_file_commit_history(file_path)
    
    def is_git_repository(self) -> bool:
        """
        æª¢æŸ¥æ˜¯å¦ç‚º git å„²å­˜åº«
        
        Returns:
            æ˜¯å¦ç‚º git å„²å­˜åº«
        """
        try:
            result = subprocess.run(
                ['git', 'rev-parse', '--git-dir'],
                cwd=self._extractor._repo_path,
                capture_output=True,
                text=True
            )
            return result.returncode == 0
        except Exception:
            return False
