# Generated by Copilot
"""
Git History Issue ç·¨è™Ÿæå–å·¥å…· - éœé»˜ç‰ˆ
åªå›å‚³ç¬¦åˆ refs #ç·¨è™Ÿ æ ¼å¼çš„ issue ç·¨è™Ÿå­—ä¸²ï¼Œä¸é¡¯ç¤ºèª¿è©¦ä¿¡æ¯
"""
import subprocess
import re
from pathlib import Path
from typing import Set, List


class SilentGitExtractor:
    """éœé»˜çš„ Git issue ç·¨è™Ÿæå–å™¨"""
    
    def __init__(self, repo_path: str = "."):
        """åˆå§‹åŒ–æå–å™¨"""
        self._repo_path = Path(repo_path).resolve()
    
    def extract_issue_numbers(self, file_path: str) -> str:
        """
        å¾æª”æ¡ˆçš„ git history ä¸­æå– issue ç·¨è™Ÿ
        
        Args:
            file_path: æª”æ¡ˆè·¯å¾‘
            
        Returns:
            é€—è™Ÿåˆ†éš”çš„ issue ç·¨è™Ÿå­—ä¸²
        """
        try:
            commits = self._get_file_commits(file_path)
            issue_numbers = self._extract_numbers_from_commits(commits)
            return ",".join(sorted(issue_numbers))
        except Exception:
            return ""
    
    def _get_file_commits(self, file_path: str) -> List[dict]:
        """å–å¾—æª”æ¡ˆçš„ commit è¨˜éŒ„ï¼ˆéœé»˜æ¨¡å¼ï¼‰"""
        try:
            cmd = [
                'git', 'log', 
                '--follow',
                '--format=%H|%an|%ad|%s',
                '--date=iso',
                '--',
                file_path
            ]
            
            result = subprocess.run(
                cmd,
                cwd=self._repo_path,
                capture_output=True,
                text=True,
                encoding='utf-8'
            )
            
            if result.returncode != 0:
                return []
            
            commits = []
            lines = result.stdout.strip().split('\n')
            
            for line in lines:
                if line.strip():
                    parts = line.split('|', 3)
                    if len(parts) >= 4:
                        commit = {
                            'hash': parts[0],
                            'author': parts[1],
                            'date': parts[2],
                            'message': parts[3]
                        }
                        commits.append(commit)
            
            return commits
            
        except Exception:
            return []
    
    def _extract_numbers_from_commits(self, commits: List[dict]) -> Set[str]:
        """å¾ commit è¨Šæ¯ä¸­æå– issue ç·¨è™Ÿ"""
        issue_numbers = set()
        pattern = r"refs\s+#(\d+)"
        regex = re.compile(pattern, re.IGNORECASE)
        
        for commit in commits:
            message = commit.get('message', '')
            matches = regex.findall(message)
            issue_numbers.update(matches)
        
        return issue_numbers
    
    def is_git_repository(self) -> bool:
        """æª¢æŸ¥æ˜¯å¦ç‚º git å„²å­˜åº«"""
        try:
            result = subprocess.run(
                ['git', 'rev-parse', '--git-dir'],
                cwd=self._repo_path,
                capture_output=True,
                text=True
            )
            return result.returncode == 0
        except Exception:
            return False


def print_simple_header():
    """é¡¯ç¤ºç°¡åŒ–çš„å·¥å…·æ¨™é¡Œ"""
    print("=" * 50)
    print("     Git History Issue ç·¨è™Ÿæå–")
    print("=" * 50)
    print("æå–ç¬¦åˆ 'refs #ç·¨è™Ÿ' æ ¼å¼çš„ issue ç·¨è™Ÿ")
    print()


def get_repo_path():
    """å–å¾—å„²å­˜åº«è·¯å¾‘"""
    print("è«‹è¼¸å…¥ Git å„²å­˜åº«è·¯å¾‘ (æˆ–æŒ‰ Enter ä½¿ç”¨ç•¶å‰ç›®éŒ„):")
    user_input = input("> ").strip()
    
    if not user_input:
        user_input = "."
    
    if not Path(user_input).exists():
        print(f"âŒ è·¯å¾‘ä¸å­˜åœ¨: {user_input}")
        return None
    
    extractor = SilentGitExtractor(user_input)
    if not extractor.is_git_repository():
        print(f"âŒ ä¸æ˜¯ Git å„²å­˜åº«: {user_input}")
        return None
    
    return str(Path(user_input).resolve())


def get_file_path():
    """å–å¾—æª”æ¡ˆè·¯å¾‘"""
    print("\nè«‹è¼¸å…¥æª”æ¡ˆè·¯å¾‘ (ç›¸å°æ–¼å„²å­˜åº«æ ¹ç›®éŒ„):")
    print("ä¾‹å¦‚: src/main.py æˆ– Controllers/ProductController.cs")
    file_path = input("> ").strip()
    
    if not file_path:
        print("âŒ æª”æ¡ˆè·¯å¾‘ä¸èƒ½ç‚ºç©º")
        return None
    
    return file_path


def extract_cli(repo_path=None):
    """äº’å‹• CLI ç‰ˆï¼šä¿ç•™åŸæœ‰äº’å‹•æµç¨‹"""
    try:
        print_simple_header()

        # å–å¾—å„²å­˜åº«è·¯å¾‘
        if repo_path is None:
            repo_path = get_repo_path()
        if not repo_path:
            return

        extractor = SilentGitExtractor(repo_path)
        print(f"âœ… Git å„²å­˜åº«: {repo_path}")

        while True:
            # å–å¾—æª”æ¡ˆè·¯å¾‘
            file_path = get_file_path()
            if not file_path:
                continue

            # æå– issue ç·¨è™Ÿ
            print(f"\nğŸ” åˆ†ææª”æ¡ˆ: {file_path}")
            issue_numbers = extractor.extract_issue_numbers(file_path)

            # åªé¡¯ç¤ºçµæœ
            if issue_numbers:
                print(f"ğŸ“‹ Issue ç·¨è™Ÿ: {issue_numbers}")
            else:
                print("ğŸ“‹ æœªæ‰¾åˆ°ç¬¦åˆæ ¼å¼çš„ issue ç·¨è™Ÿ")

            # è©¢å•æ˜¯å¦ç¹¼çºŒ
            print("\n" + "-" * 30)
            continue_choice = input("ç¹¼çºŒåˆ†æå…¶ä»–æª”æ¡ˆï¼Ÿ(y/n): ").strip().lower()
            if continue_choice not in ['y', 'yes', '']:
                break

        print("\nğŸ‘‹ å®Œæˆï¼")

    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ¶ä¸­æ–·æ“ä½œ")
    except Exception as e:
        print(f"\nâŒ ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤: {e}")
    finally:
        input("\næŒ‰ Enter éµçµæŸ...")


def main(pause_on_exit=True):
    """éäº’å‹•ä¸»ç¨‹å¼å…¥å£ï¼Œä¾›è¢«åŒ¯å…¥å‘¼å«ã€‚è‹¥ pause_on_exit=Trueï¼Œæœ€å¾Œæœƒè¦æ±‚æŒ‰éµçµæŸä»¥ä¿ç•™è¦–çª—ï¼ˆåŸè¡Œç‚ºï¼‰ã€‚"""
    try:
        print_simple_header()
        repo_path = get_repo_path()
        if not repo_path:
            return False

        extractor = SilentGitExtractor(repo_path)
        print(f"âœ… Git å„²å­˜åº«: {repo_path}")

        while True:
            file_path = get_file_path()
            if not file_path:
                continue

            print(f"\nğŸ” åˆ†ææª”æ¡ˆ: {file_path}")
            issue_numbers = extractor.extract_issue_numbers(file_path)

            if issue_numbers:
                print(f"ğŸ“‹ Issue ç·¨è™Ÿ: {issue_numbers}")
            else:
                print("ğŸ“‹ æœªæ‰¾åˆ°ç¬¦åˆæ ¼å¼çš„ issue ç·¨è™Ÿ")

            print("\n" + "-" * 30)
            continue_choice = input("ç¹¼çºŒåˆ†æå…¶ä»–æª”æ¡ˆï¼Ÿ(y/n): ").strip().lower()
            if continue_choice not in ['y', 'yes', '']:
                break

        print("\nğŸ‘‹ å®Œæˆï¼")
        return True

    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ¶ä¸­æ–·æ“ä½œ")
        return False
    except Exception as e:
        print(f"\nâŒ ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤: {e}")
        return False
    finally:
        if pause_on_exit:
            try:
                input("\næŒ‰ Enter éµçµæŸ...")
            except Exception:
                pass


if __name__ == "__main__":
    main()
